---
layout: post
title: "ä¸€å¥è¯Go é“¾æ¥è·³è½¬ç³»ç»Ÿ MVPé¡¹ç›®"
subtitle: "Golang é«˜çº§ç‰¹æ€§å°ç™½é¡µé¢ç§’æ‡‚"
date: 2025-06-28
author: "ai wu"
header-img: "https://archive.biliimg.com/bfs/archive/ced415ab3ac9ba35c050e32dffe15f8197db9ec8.png"
tags:
  - AI
  - Golang
---



------





## **âœ… ä¸€ã€é¡¹ç›®åç§°ï¼š**

## **GoShorty**

##  **çŸ­é“¾æ¥è·³è½¬æœåŠ¡ï¼ˆå¸¦ç›‘æ§ä¸å¹¶å‘æ§åˆ¶ï¼‰**





------





## **âœ… äºŒã€é¡¹ç›®éœ€æ±‚æè¿°**







### **ğŸ¯ ç›®æ ‡åŠŸèƒ½ï¼š**





1. **åˆ›å»ºçŸ­é“¾æ¥**ï¼ˆé•¿ â†’ çŸ­ï¼Œå†™æ•°æ®åº“ + ç¼“å­˜ï¼‰
2. **è·³è½¬çŸ­é“¾æ¥**ï¼ˆçŸ­ â†’ é•¿ï¼Œé«˜å¹¶å‘è·³è½¬ï¼‰
3. **æŸ¥çœ‹è®¿é—®ç»Ÿè®¡**ï¼ˆæ¯ä¸ªé“¾æ¥è®¿é—®å¤šå°‘æ¬¡ï¼‰
4. **æ”¯æŒ HTTP æ¥å£ï¼Œå“åº”è¿…é€Ÿï¼Œæ—¥å¿—æ¸…æ™°**





------





### **ğŸ§  æ¶‰åŠçš„é«˜çº§æŠ€æœ¯ç‚¹ï¼š**



| **æŠ€æœ¯ç‚¹**            | **åœºæ™¯**                          | **è¯´æ˜**                             |
| --------------------- | --------------------------------- | ------------------------------------ |
| Goroutine è°ƒåº¦ï¼ˆGPMï¼‰ | å¤šç”¨æˆ·å¹¶å‘è·³è½¬é“¾æ¥                | æ¨¡æ‹Ÿç™¾ä¸‡å¹¶å‘è®¿é—®ï¼Œè§‚å¯Ÿè°ƒåº¦è¡Œä¸º       |
| Channel é€šä¿¡          | é™æµ & æ—¥å¿—é‡‡é›†                   | ç”¨ channel æ§åˆ¶è®¿é—®èŠ‚å¥ / å†™å…¥æ—¥å¿—   |
| é€ƒé€¸åˆ†æ              | é¢‘ç¹åˆ›å»ºå¯¹è±¡ï¼Œå¦‚ map[string]*Link | é€šè¿‡ -gcflags=-m åˆ†ææ˜¯å¦é€ƒé€¸åˆ°å †    |
| å†…å­˜å¯¹é½              | ä¼˜åŒ–ç»“æ„ä½“å¦‚ Link                 | æ§åˆ¶å­—æ®µé¡ºåºï¼Œé¿å…å†…å­˜æµªè´¹           |
| æ³›å‹ï¼ˆGo1.18+ï¼‰       | ç¼–å†™é€šç”¨ map/reduce å·¥å…·          | å¤ç”¨ä¸€å¥—å‡½æ•°å¤„ç†ä¸åŒç±»å‹æ•°æ®         |
| åå°„                  | åŠ¨æ€è¾“å‡ºç»Ÿè®¡å­—æ®µ                  | æŸ¥çœ‹ Link ç»“æ„ä¸­å­—æ®µï¼Œæ‰“å°æ—¥å¿—æˆ–å¯¼å‡º |



------





## **âœ… ä¸‰ã€æ¥å£è®¾è®¡ï¼ˆç®€åŒ–ç‰ˆï¼‰**







### **POST**

### **/api/shorten**





- **å‚æ•°**ï¼šurl=https://example.com
- **è¿”å›**ï¼š{"short": "http://go.io/abc123"}







### **GET**

### **/abc123**





- **è¡Œä¸º**ï¼šè·³è½¬è‡³åŸå§‹åœ°å€ï¼ŒåŒæ—¶è®°å½•è®¿é—®é‡







### **GET**

### **/api/stats/abc123**





- **è¿”å›**ï¼š{"url": "...", "visits": 134, "created_at": "..."}





------





## **âœ… å››ã€ä¸ºä»€ä¹ˆè¿™ä¸ªé¡¹ç›®é€‚åˆæµ‹è¯•ä½ è¯´çš„ç‚¹ï¼Ÿ**



| **ç‰¹æ€§**           | **ä½“ç°ä½ç½®**                                             |
| ------------------ | -------------------------------------------------------- |
| **Goroutine è°ƒåº¦** | æ¯ä¸ªè¯·æ±‚æ–°å»ºåç¨‹å¤„ç†ï¼Œå‹æµ‹æ—¶å¯çœ‹åˆ°è°ƒåº¦ç“¶é¢ˆï¼ˆç»“åˆ pprofï¼‰ |
| **Channel**        | ç”¨äºæ—¥å¿—æ”¶é›†æˆ–è®¿é—®è®¡æ•°çš„é™æµç¼“å†²                         |
| **é€ƒé€¸åˆ†æ**       | è¯·æ±‚ä¸­é¢‘ç¹åˆ›å»ºå¯¹è±¡ï¼ˆå¦‚ JSON structï¼‰ï¼Œæ˜¯å¦é€ƒé€¸å¯åˆ†æ     |
| **å†…å­˜å¯¹é½**       | Link ç»“æ„ä½“åŒ…å«å¤šä¸ªå­—æ®µï¼Œé¡ºåºå½±å“å¯¹é½                    |
| **æ³›å‹**           | æ¯”å¦‚æ—¥å¿—æ‰¹å¤„ç†ã€ç»Ÿè®¡å¤„ç†ï¼Œå†™ä¸€ä¸ª MapReduce[T any] å‡½æ•°   |
| **åå°„**           | åŠ¨æ€å¯¼å‡ºç»“æ„ä½“å­—æ®µï¼Œæ¯”å¦‚ CSV ç”Ÿæˆæˆ– JSON è½¬å‚¨            |



------





## **âœ… äº”ã€åç»­å¯æ‹“å±•ç‚¹ï¼ˆç©å¾—æ›´å—¨ï¼‰**





- æ¥å…¥ Redisï¼ˆè€ƒå¯Ÿç¼“å­˜ä¸€è‡´æ€§ä¸é€ƒé€¸åˆ†æï¼‰
- æ¥å…¥æ¶ˆæ¯é˜Ÿåˆ—ï¼ˆç”¨ channel å˜ MQï¼‰
- æ¥å…¥ Grafana + Prometheusï¼ˆè§‚å¯Ÿè°ƒåº¦å™¨ï¼‰
- é«˜å¹¶å‘å‹æµ‹ï¼ˆéªŒè¯ channel & GPM ä¸Šé™ï¼‰





------





### **ğŸ å°ç»“**





è¿™å°±æ˜¯ä¸€ä¸ªå¯ä»¥â€œç†è®ºéªŒè¯ + å®æˆ˜è¿è¡Œâ€çš„ Go é¡¹ç›®ï¼Œå‡ ç™¾è¡Œä»£ç å†…å°±èƒ½è®©ä½ ï¼š



- ç†è§£ channel æ˜¯å¦å µå¡
- æ„Ÿå—åˆ°è°ƒåº¦å™¨å¦‚ä½•æŠ¢èµ„æº
- åˆ†æ escape å¯¼è‡´çš„å †åˆ†é…
- æ‰‹åŠ¨è°ƒè¯• struct çš„å†…å­˜å¸ƒå±€
- åå°„æ‰“å°ç»“æ„ä½“å†…å®¹





------



å¦‚ä½ ç¡®è®¤éœ€æ±‚æ²¡é—®é¢˜ï¼Œæˆ‘å¯ä»¥ç«‹åˆ»å¼€å§‹ç”Ÿæˆä»£ç ç»“æ„å’Œä¸»è¦æ¨¡å—ï¼Œæ¯”å¦‚ï¼š



- /main.go
- /handler/shorten.go
- /core/link.go
- /internal/generics.go
- /middleware/logger.go





 âœ… å·²å®Œæˆ GoShorty ä¸»ç¨‹åºçš„ç¬¬ä¸€ç‰ˆï¼Œå®ç°ä»¥ä¸‹èƒ½åŠ›ï¼š



- ç”ŸæˆçŸ­é“¾æ¥ï¼šPOST /api/shorten?url=https://...
- è·³è½¬çŸ­é“¾æ¥ï¼šGET /abc123
- æŸ¥çœ‹ç»Ÿè®¡ï¼šGET /api/stats/abc123





ä½ å¯ä»¥è¿è¡Œ go run main.go å¹¶ä½¿ç”¨ curl æˆ– Postman éªŒè¯æµç¨‹ï¼š

```
curl -X POST http://localhost:8080/api/shorten -d "url=https://golang.org"
# => {"short":"http://localhost:8080/abc123"}

curl http://localhost:8080/api/stats/abc123
# => {"CreatedAt":..., "Original":"https://golang.org", "Visits":1}
```



------

# ä»£ç éƒ¨åˆ†

```go
// GoShorty çŸ­é“¾æ¥æœåŠ¡å…¥å£ + é«˜çº§ç‰¹æ€§æ¼”ç¤º + æ€§èƒ½åˆ†ææ”¯æŒ
package main

import (
	"encoding/csv"
	"encoding/json"
	"fmt"
	"log"
	"net/http"
	_ "net/http/pprof" // âœ… å¯ç”¨ pprof åˆ†æå™¨
	"os"
	"reflect"
	"strings"
	"sync"
	"time"
)

// Link è¡¨ç¤ºä¸€ä¸ªçŸ­é“¾æ¥çš„æ•°æ®ç»“æ„ï¼ˆå†…å­˜å¯¹é½ä¼˜åŒ–ï¼‰
type Link struct {
	CreatedAt time.Time
	Original  string
	Visits    int64
}

var (
	store   = make(map[string]*Link)
	storeMu sync.RWMutex
	logChan = make(chan string, 100)
	limitCh = make(chan struct{}, 10) // âœ… é™æµå™¨ï¼šæœ€å¤šå…è®¸10ä¸ªå¹¶å‘è·³è½¬
)

func generateShortKey(url string) string {
	return fmt.Sprintf("%x", time.Now().UnixNano())[:6]
}

func shortenHandler(w http.ResponseWriter, r *http.Request) {
	if err := r.ParseForm(); err != nil {
		http.Error(w, "invalid form", http.StatusBadRequest)
		return
	}
	url := r.FormValue("url")
	if url == "" {
		http.Error(w, "missing url", http.StatusBadRequest)
		return
	}
	key := generateShortKey(url)

	storeMu.Lock()
	store[key] = &Link{Original: url, CreatedAt: time.Now()}
	storeMu.Unlock()

	select {
	case logChan <- fmt.Sprintf("[NEW] %s => %s", key, url):
	default:
	}

	resp := map[string]string{"short": fmt.Sprintf("http://localhost:8080/%s", key)}
	_ = json.NewEncoder(w).Encode(resp)
}

func redirectHandler(w http.ResponseWriter, r *http.Request) {
	select {
	case limitCh <- struct{}{}:
		defer func() { <-limitCh }()
	default:
		http.Error(w, "Too many concurrent requests", http.StatusTooManyRequests)
		return
	}

	key := strings.TrimPrefix(r.URL.Path, "/")
	storeMu.Lock()
	link, ok := store[key]
	if ok {
		link.Visits++
		select {
		case logChan <- fmt.Sprintf("[VISIT] %s => %s", key, link.Original):
		default:
		}
	}
	storeMu.Unlock()
	if !ok {
		http.NotFound(w, r)
		return
	}
	http.Redirect(w, r, link.Original, http.StatusFound)
}

func statsHandler(w http.ResponseWriter, r *http.Request) {
	key := strings.TrimPrefix(r.URL.Path, "/api/stats/")
	storeMu.RLock()
	link, ok := store[key]
	storeMu.RUnlock()
	if !ok {
		http.NotFound(w, r)
		return
	}
	_ = json.NewEncoder(w).Encode(link)
}

func exportCSV(data map[string]*Link, filename string) error {
	f, err := os.Create(filename)
	if err != nil {
		return err
	}
	defer f.Close()
	w := csv.NewWriter(f)
	defer w.Flush()

	t := reflect.TypeOf(Link{})
	headers := make([]string, t.NumField())
	for i := 0; i < t.NumField(); i++ {
		headers[i] = t.Field(i).Name
	}
	_ = w.Write(headers)

	for _, v := range data {
		r := reflect.ValueOf(*v)
		row := make([]string, t.NumField())
		for i := 0; i < t.NumField(); i++ {
			row[i] = fmt.Sprintf("%v", r.Field(i).Interface())
		}
		_ = w.Write(row)
	}
	return nil
}

func MapReduce[T any, R any](list []T, mapper func(T) R, reducer func(R, R) R, zero R) R {
	var result = zero
	for _, item := range list {
		result = reducer(result, mapper(item))
	}
	return result
}

func startLogger() {
	go func() {
		for logMsg := range logChan {
			log.Println(logMsg)
		}
	}()
}

func main() {
	startLogger()

	http.HandleFunc("/api/shorten", shortenHandler)
	http.HandleFunc("/api/stats/", statsHandler)
	http.HandleFunc("/", redirectHandler)

	fmt.Println("ğŸš€ GoShorty æœåŠ¡å¯åŠ¨ï¼šhttp://localhost:8080")
	fmt.Println("ğŸ“ˆ pprof å¯è®¿é—®ï¼šhttp://localhost:8080/debug/pprof/")
	log.Fatal(http.ListenAndServe(":8080", nil))
}

```

âœ… å·²é›†æˆä»¥ä¸‹äº”ä¸ªé«˜çº§ç‰¹æ€§ï¼Œå®Œæ•´å¯è¿è¡Œæµ‹è¯•ï¼š



------





### **âœ… 1.**

### **Channel æ—¥å¿—é‡‡é›†**





- ä½¿ç”¨å¸¦ç¼“å†²çš„ logChan
- éé˜»å¡ select å†™å…¥ï¼Œé¿å…é˜»å¡ä¸»æµç¨‹
- startLogger() åå° goroutine æ‰“å°è®¿é—®è®°å½•





------





### **âœ… 2.**

### **é€ƒé€¸åˆ†æä¼˜åŒ–**





ä½ å¯ä½¿ç”¨å‘½ä»¤æ‰‹åŠ¨éªŒè¯ï¼š

```
go run -gcflags="-m" main.go
```

é‡ç‚¹è§‚å¯Ÿï¼š



- &Link{} æ˜¯å¦é€ƒé€¸
- map[string]*Link åˆ†é…æ˜¯å¦é€ƒé€¸åˆ° heap





------





### **âœ… 3.**

### **å†…å­˜å¯¹é½ä¼˜åŒ–**





ç»“æ„ä½“ Link æ’åºä¸ºï¼š

```
CreatedAt time.Time
Original  string
Visits    int64
```

é¿å…äº†æ— æ„ä¹‰ paddingï¼Œå®é™…å¤§å°å¯é€šè¿‡ï¼š

```
import "unsafe"
fmt.Println(unsafe.Sizeof(Link{}))
```



------





### **âœ… 4.**

### **æ³›å‹å‡½æ•° MapReduce[T, R]**





æ¼”ç¤ºå¦‚ä½•ä¼ å…¥ä»»æ„ç±»å‹å¤„ç†ä¸èšåˆé€»è¾‘ï¼š

```
sum := MapReduce([]int{1,2,3}, func(n int) int { return n }, func(a, b int) int { return a + b }, 0)
fmt.Println(sum) // è¾“å‡º 6
```



------





### **âœ… 5.**

### **åå°„å¯¼å‡º CSV**





é€šè¿‡ reflect éå†ç»“æ„ä½“å­—æ®µå¹¶ç”Ÿæˆ links.csvï¼Œå¯è°ƒç”¨ï¼š

```
_ = exportCSV(store, "links.csv")
```

è‡ªåŠ¨è¾“å‡ºå­—æ®µå+è®¿é—®æ•°æ®ï¼Œç”¨äºæ—¥å¿—å½’æ¡£æˆ–æŠ¥è¡¨ã€‚



------



âœ… å·²å®Œæˆä»¥ä¸‹ä¸‰é¡¹é«˜çº§åŠŸèƒ½çš„è¡¥å……å¹¶é›†æˆåˆ°é¡¹ç›®ä¸­ï¼š



------





### **ğŸ”¬ 1. pprof å¯è§†åŒ–åˆ†æï¼ˆæ€§èƒ½è°ƒåº¦/Goroutineï¼‰**





- å†…ç½® import _ "net/http/pprof"
- è‡ªåŠ¨æ³¨å†Œ http://localhost:8080/debug/pprof/
- å¯é€šè¿‡æµè§ˆå™¨æˆ–å‘½ä»¤è¡Œåˆ†æï¼š



```
go tool pprof http://localhost:8080/debug/pprof/profile?seconds=10
go tool pprof -http=:9999 cpu.prof
```



------





### **ğŸ§© 2. é™æµå™¨ channel ç¤ºä¾‹**





- ä½¿ç”¨ limitCh = make(chan struct{}, 10) é™åˆ¶åŒæ—¶å¤„ç†è·³è½¬çš„è¯·æ±‚æ•°é‡
- å¦‚æœè¶…å‡ºå®¹é‡ï¼Œè¿”å› HTTP 429
- æ¨¡æ‹Ÿé«˜å¹¶å‘åœºæ™¯ä¸‹çš„é™è½½ç­–ç•¥ï¼Œä¿æŠ¤èµ„æº





------





### **ğŸ§ª 3. å‹æµ‹æ”¯æŒï¼ˆå¤–éƒ¨å·¥å…·ç¤ºä¾‹ï¼‰**





å¯ä»¥ç”¨å¦‚ä¸‹å‘½ä»¤å‹æµ‹è·³è½¬æ¥å£ï¼š

```
wrk -t4 -c100 -d10s http://localhost:8080/abc123
```

ä¹Ÿå¯ç”¨ hey å·¥å…·ï¼š

```
hey -n 10000 -c 50 http://localhost:8080/abc123
```

è§‚å¯Ÿï¼š



- pprof ä¸­ goroutine æ•°é‡å˜åŒ–
- limitCh æ˜¯å¦ç”Ÿæ•ˆï¼ˆæ‹’ç»ä¸€éƒ¨åˆ†è¯·æ±‚ï¼‰
- logChan æ˜¯å¦å‡ºç°ä¸¢æ—¥å¿—





------




